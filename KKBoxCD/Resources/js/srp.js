if (typeof module !== 'undefined') {
    module.exports = SRP;
}

function SRP() {
    this.N = null;
    this.g = null;
    this.a = null;
    this.b = null;
    this.A = null;
    this.B = null;
    this.clientK = null;
    this.serverK = null;
    this.M1 = null;
    this.M2 = null;
    this.k = null;
    this.I = null;
    this.p = null;
    this.x = null;
    this.s = null;
    this.v = null;
}
SRP.prototype.init = function (g) {
    switch (g) {
        case "G3072":
            this.N = new BigInteger("FFFFFFFFFFFFFFFFC90FDAA22168C234C4C6628B80DC1CD129024E088A67CC74020BBEA63B139B22514A08798E3404DDEF9519B3CD3A431B302B0A6DF25F14374FE1356D6D51C245E485B576625E7EC6F44C42E9A637ED6B0BFF5CB6F406B7EDEE386BFB5A899FA5AE9F24117C4B1FE649286651ECE45B3DC2007CB8A163BF0598DA48361C55D39A69163FA8FD24CF5F83655D23DCA3AD961C62F356208552BB9ED529077096966D670C354E4ABC9804F1746C08CA18217C32905E462E36CE3BE39E772C180E86039B2783A2EC07A28FB5C55DF06F4C52C9DE2BCBF6955817183995497CEA956AE515D2261898FA051015728E5A8AAAC42DAD33170D04507A33A85521ABDF1CBA64ECFB850458DBEF0A8AEA71575D060C7DB3970F85A6E1E4C7ABF5AE8CDB0933D71E8C94E04A25619DCEE3D2261AD2EE6BF12FFA06D98A0864D87602733EC86A64521F2B18177B200CBBE117577A615D6C770988C0BAD946E208E24FA074E5AB3143DB5BFCE0FD108E4B82D120A93AD2CAFFFFFFFFFFFFFFFF", 16);
            this.g = new BigInteger("5");
            break;
        case "G4096":
            this.N = new BigInteger("FFFFFFFFFFFFFFFFC90FDAA22168C234C4C6628B80DC1CD129024E088A67CC74020BBEA63B139B22514A08798E3404DDEF9519B3CD3A431B302B0A6DF25F14374FE1356D6D51C245E485B576625E7EC6F44C42E9A637ED6B0BFF5CB6F406B7EDEE386BFB5A899FA5AE9F24117C4B1FE649286651ECE45B3DC2007CB8A163BF0598DA48361C55D39A69163FA8FD24CF5F83655D23DCA3AD961C62F356208552BB9ED529077096966D670C354E4ABC9804F1746C08CA18217C32905E462E36CE3BE39E772C180E86039B2783A2EC07A28FB5C55DF06F4C52C9DE2BCBF6955817183995497CEA956AE515D2261898FA051015728E5A8AAAC42DAD33170D04507A33A85521ABDF1CBA64ECFB850458DBEF0A8AEA71575D060C7DB3970F85A6E1E4C7ABF5AE8CDB0933D71E8C94E04A25619DCEE3D2261AD2EE6BF12FFA06D98A0864D87602733EC86A64521F2B18177B200CBBE117577A615D6C770988C0BAD946E208E24FA074E5AB3143DB5BFCE0FD108E4B82D120A92108011A723C12A787E6D788719A10BDBA5B2699C327186AF4E23C1A946834B6150BDA2583E9CA2AD44CE8DBBBC2DB04DE8EF92E8EFC141FBECAA6287C59474E6BC05D99B2964FA090C3A2233BA186515BE7ED1F612970CEE2D7AFB81BDD762170481CD0069127D5B05AA993B4EA988D8FDDC186FFB7DC90A6C08F4DF435C934063199FFFFFFFFFFFFFFFF", 16);
            this.g = new BigInteger("5");
            break;
        case "G6144":
            this.N = new BigInteger("FFFFFFFFFFFFFFFFC90FDAA22168C234C4C6628B80DC1CD129024E088A67CC74020BBEA63B139B22514A08798E3404DDEF9519B3CD3A431B302B0A6DF25F14374FE1356D6D51C245E485B576625E7EC6F44C42E9A637ED6B0BFF5CB6F406B7EDEE386BFB5A899FA5AE9F24117C4B1FE649286651ECE45B3DC2007CB8A163BF0598DA48361C55D39A69163FA8FD24CF5F83655D23DCA3AD961C62F356208552BB9ED529077096966D670C354E4ABC9804F1746C08CA18217C32905E462E36CE3BE39E772C180E86039B2783A2EC07A28FB5C55DF06F4C52C9DE2BCBF6955817183995497CEA956AE515D2261898FA051015728E5A8AAAC42DAD33170D04507A33A85521ABDF1CBA64ECFB850458DBEF0A8AEA71575D060C7DB3970F85A6E1E4C7ABF5AE8CDB0933D71E8C94E04A25619DCEE3D2261AD2EE6BF12FFA06D98A0864D87602733EC86A64521F2B18177B200CBBE117577A615D6C770988C0BAD946E208E24FA074E5AB3143DB5BFCE0FD108E4B82D120A92108011A723C12A787E6D788719A10BDBA5B2699C327186AF4E23C1A946834B6150BDA2583E9CA2AD44CE8DBBBC2DB04DE8EF92E8EFC141FBECAA6287C59474E6BC05D99B2964FA090C3A2233BA186515BE7ED1F612970CEE2D7AFB81BDD762170481CD0069127D5B05AA993B4EA988D8FDDC186FFB7DC90A6C08F4DF435C93402849236C3FAB4D27C7026C1D4DCB2602646DEC9751E763DBA37BDF8FF9406AD9E530EE5DB382F413001AEB06A53ED9027D831179727B0865A8918DA3EDBEBCF9B14ED44CE6CBACED4BB1BDB7F1447E6CC254B332051512BD7AF426FB8F401378CD2BF5983CA01C64B92ECF032EA15D1721D03F482D7CE6E74FEF6D55E702F46980C82B5A84031900B1C9E59E7C97FBEC7E8F323A97A7E36CC88BE0F1D45B7FF585AC54BD407B22B4154AACC8F6D7EBF48E1D814CC5ED20F8037E0A79715EEF29BE32806A1D58BB7C5DA76F550AA3D8A1FBFF0EB19CCB1A313D55CDA56C9EC2EF29632387FE8D76E3C0468043E8F663F4860EE12BF2D5B0B7474D6E694F91E6DCC4024FFFFFFFFFFFFFFFF", 16);
            this.g = new BigInteger("5");
            break;
        case "G8192":
            this.N = new BigInteger("FFFFFFFFFFFFFFFFC90FDAA22168C234C4C6628B80DC1CD129024E088A67CC74020BBEA63B139B22514A08798E3404DDEF9519B3CD3A431B302B0A6DF25F14374FE1356D6D51C245E485B576625E7EC6F44C42E9A637ED6B0BFF5CB6F406B7EDEE386BFB5A899FA5AE9F24117C4B1FE649286651ECE45B3DC2007CB8A163BF0598DA48361C55D39A69163FA8FD24CF5F83655D23DCA3AD961C62F356208552BB9ED529077096966D670C354E4ABC9804F1746C08CA18217C32905E462E36CE3BE39E772C180E86039B2783A2EC07A28FB5C55DF06F4C52C9DE2BCBF6955817183995497CEA956AE515D2261898FA051015728E5A8AAAC42DAD33170D04507A33A85521ABDF1CBA64ECFB850458DBEF0A8AEA71575D060C7DB3970F85A6E1E4C7ABF5AE8CDB0933D71E8C94E04A25619DCEE3D2261AD2EE6BF12FFA06D98A0864D87602733EC86A64521F2B18177B200CBBE117577A615D6C770988C0BAD946E208E24FA074E5AB3143DB5BFCE0FD108E4B82D120A92108011A723C12A787E6D788719A10BDBA5B2699C327186AF4E23C1A946834B6150BDA2583E9CA2AD44CE8DBBBC2DB04DE8EF92E8EFC141FBECAA6287C59474E6BC05D99B2964FA090C3A2233BA186515BE7ED1F612970CEE2D7AFB81BDD762170481CD0069127D5B05AA993B4EA988D8FDDC186FFB7DC90A6C08F4DF435C93402849236C3FAB4D27C7026C1D4DCB2602646DEC9751E763DBA37BDF8FF9406AD9E530EE5DB382F413001AEB06A53ED9027D831179727B0865A8918DA3EDBEBCF9B14ED44CE6CBACED4BB1BDB7F1447E6CC254B332051512BD7AF426FB8F401378CD2BF5983CA01C64B92ECF032EA15D1721D03F482D7CE6E74FEF6D55E702F46980C82B5A84031900B1C9E59E7C97FBEC7E8F323A97A7E36CC88BE0F1D45B7FF585AC54BD407B22B4154AACC8F6D7EBF48E1D814CC5ED20F8037E0A79715EEF29BE32806A1D58BB7C5DA76F550AA3D8A1FBFF0EB19CCB1A313D55CDA56C9EC2EF29632387FE8D76E3C0468043E8F663F4860EE12BF2D5B0B7474D6E694F91E6DBE115974A3926F12FEE5E438777CB6A932DF8CD8BEC4D073B931BA3BC832B68D9DD300741FA7BF8AFC47ED2576F6936BA424663AAB639C5AE4F5683423B4742BF1C978238F16CBE39D652DE3FDB8BEFC848AD922222E04A4037C0713EB57A81A23F0C73473FC646CEA306B4BCBC8862F8385DDFA9D4B7FA2C087E879683303ED5BDD3A062B3CF5B3A278A66D2A13F83F44F82DDF310EE074AB6A364597E899A0255DC164F31CC50846851DF9AB48195DED7EA1B1D510BD7EE74D73FAF36BC31ECFA268359046F4EB879F924009438B481C6CD7889A002ED5EE382BC9190DA6FC026E479558E4475677E9AA9E3050E2765694DFC81F56E880B96E7160C980DD98EDD3DFFFFFFFFFFFFFFFFF", 16);
            this.g = new BigInteger("19");
            break;
        case "G2048":
        default:
            this.N = new BigInteger("AC6BDB41324A9A9BF166DE5E1389582FAF72B6651987EE07FC3192943DB56050A37329CBB4A099ED8193E0757767A13DD52312AB4B03310DCD7F48A9DA04FD50E8083969EDB767B0CF6095179A163AB3661A05FBD5FAAAE82918A9962F0B93B855F97993EC975EEAA80D740ADBF4FF747359D041D5C33EA71D281E446B14773BCA97B43A23FB801676BD207A436C6481F1D2B9078717461A5B9D32E688F87748544523B524B0D57D5EA77A2775D2ECFA032CFBDBF52FB3786160279004E57AE6AF874E7303CE53299CCC041C7BC308D82A5698F3A8D0C38271AE35F8E9DBFBB694B5C803D89F7AE435DE236D525F54759B65E372FCD68EF20FA7111F9E4AFF73", 16);
            this.g = new BigInteger("2");
            break;
    }
};
SRP.prototype.test = function () { };
SRP.prototype.computePasswordHash = function (s, p) {
    if (!this.scrypt) this.scrypt = scrypt_module_factory();
    return this.scrypt.to_hex(this.scrypt.crypto_scrypt(this.scrypt.encode_utf8(p), this.scrypt.encode_utf8(s), 16384, 8, 1, 64));
};
SRP.prototype.computeHash = function (s) {
    if (typeof module === 'undefined') {
        if (!this.SHA256) this.SHA256 = new Hashes.SHA256();
        return this.SHA256.hex(s);
    } else {
        var hash = new Hashes.SHA256;
        return hash.hex(s);
    }
};
SRP.prototype.computeRandom = function () {
    var rndBuf;
    var rnd;
    try {
        if (typeof module == "undefined") {
            if (window.crypto.getRandomValues) {
                rndBuf = new Uint8Array(32);
                window.crypto.getRandomValues(rndBuf);
                rnd = new BigInteger(rndBuf, 256);
                rnd = rnd.abs();
                return rnd;
            }
        } else {
            var crypto = require('crypto');
            rndBuf = crypto.randomBytes(32);
            rnd = new BigInteger(rndBuf, 256);
            rnd = rnd.abs();
            return rnd;
        }
    } catch (e) {
        throw "Not enough entropy";
    }
};
SRP.prototype.computeVerifier = function () {
    this.x = new BigInteger(this.computeHash(this.s + this.computeHash(this.I + ":" + this.p)), 16);
    this.v = this.g.modPow(this.x, this.N);
    return this.v;
};
SRP.prototype.computeA = function () {
    this.k = new BigInteger(this.computeHash(this.N.toString() + "" + this.g.toString()), 16);
    do {
        this.a = this.computeRandom();
        this.A = this.g.modPow(this.a, this.N);
    } while (this.A.mod(this.N).equals(BigInteger.ZERO));
    return this.A;
};
SRP.prototype.computeB = function () {
    this.k = new BigInteger(this.computeHash(this.N.toString() + "" + this.g.toString()), 16);
    this.b = this.computeRandom();
    var Bl = this.k.multiply(this.v);
    var Br = this.g.modPow(this.b, this.N);
    var Bn = Bl.add(Br);
    this.B = Bn.mod(this.N);
    return this.B;
};
SRP.prototype.computeM1 = function () {
    var HN = new BigInteger(this.computeHash(this.N.toString()), 16);
    var Hg = new BigInteger(this.computeHash(this.g.toString()), 16);
    var HI = new BigInteger(this.computeHash(this.I.toString()), 16);
    this.M1 = this.computeHash(HN.xor(Hg).toString() + "" + HI.toString() + "" + this.s + "" + this.A.toString() + "" + this.B.toString() + "" + (this.clientK ? this.clientK : this.serverK));
    return this.M1;
};
SRP.prototype.computeM2 = function () {
    this.M2 = this.computeHash(this.A.toString() + "" + this.M1 + "" + (this.serverK ? this.serverK : this.clientK));
    return this.M2;
};
SRP.prototype.computeClientK = function () {
    var u = new BigInteger(this.computeHash(this.A.toString(16) + "" + this.B.toString(16)), 16);
    var Sl = this.B.add(this.k.multiply(this.g.modPow(this.x, this.N)).negate());
    var Sr = this.a.add(u.multiply(this.x));
    var S = Sl.modPow(Sr, this.N);
    this.clientK = this.computeHash(S.toString(16));
    return this.clientK;
};
SRP.prototype.computeServerK = function () {
    var u = new BigInteger(this.computeHash(this.A.toString() + "" + this.B.toString()), 16);
    var Sl = this.A.multiply(this.v.modPow(u, this.N));
    var S = Sl.modPow(this.b, this.N);
    this.serverK = this.computeHash(S.toString());
    return this.serverK;
};
SRP.prototype.verifyA = function () {
    if (!this.A.equals(BigInteger.ZERO)) {
        if (!this.A.mod(this.N).equals(BigInteger.ZERO)) {
            return true;
        }
    }
    return false;
};
SRP.prototype.verifyB = function () {
    if (!this.B.equals(BigInteger.ZERO)) {
        if (!this.B.mod(this.N).equals(BigInteger.ZERO)) {
            return true;
        }
    }
    return false;
};
SRP.prototype.verifyHAB = function () {
    var u = new BigInteger(this.computeHash(this.A.toString() + "" + this.B.toString()), 16);
    if (!u.equals(BigInteger.ZERO)) {
        return true;
    }
    return false;
};
SRP.prototype.verifyK = function () {
    if (this.clientK && this.serverK) {
        if (this.clientK === this.serverK) {
            return true;
        }
    }
    return false;
};